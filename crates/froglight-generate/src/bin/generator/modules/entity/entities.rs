use convert_case::{Case, Casing};
use froglight_generate::{CliArgs, DataMap};
use hashbrown::HashMap;

pub(super) async fn generate_entities(datamap: &DataMap, args: &CliArgs) -> anyhow::Result<()> {
    // Sort the versions using the manifest.
    let mut versions: Vec<_> = datamap.version_data.keys().collect();
    versions.sort_by(|a, b| datamap.manifest.compare(a, b).unwrap());

    // Collect the latest data for all entities.
    let mut entities = HashMap::new();
    for data in datamap.version_data.values() {
        for entity in data.entities.iter() {
            entities.insert(&entity.name, entity);
        }
    }

    // Sort the entities by name.
    let mut entities = entities.into_iter().collect::<Vec<_>>();
    entities.sort_by(|a, b| a.0.cmp(b.0));

    let mut entity_content = String::new();

    // Get the latest specification for each entity.
    for (index, (_, entity)) in entities.iter().enumerate() {
        let ident = entity.display_name.replace(['\''], "_").to_case(Case::Pascal);
        entity_content.push_str(&format!("    {ident} => "));

        entity_content.push_str(&format!("EntitySize({}f32,{}f32)", entity.width, entity.height));
        entity_content.push_str(", { ");

        let mob_category = entity.category.to_case(Case::Pascal);
        entity_content.push_str(&mob_category);
        entity_content.push_str(", ");

        let mob_type = entity.kind.to_case(Case::Pascal);
        entity_content.push_str(&mob_type);
        entity_content.push_str("Entity, ");

        for (index, metadata) in entity.metadata.iter().enumerate() {
            let meta_ident = metadata.to_case(Case::Pascal);
            entity_content.push_str(&meta_ident);

            if index < entity.metadata.len() - 1 {
                entity_content.push_str(", ");
            }
        }

        if index < entities.len() - 1 {
            entity_content.push_str(" },\n");
        } else {
            entity_content.push_str(" }");
        }
    }

    let content = format!(
        r"//! Generated entities for all versions.
//!
//! @generated by 'TODO'
#[allow(clippy::wildcard_imports)]
use super::{{metadata::*, size::EntitySize}};

froglight_macros::impl_generated_entities! {{
{entity_content}
}}
"
    );

    let file_path = args.dir.join("crates/froglight-entity/src/generated/entity.rs");
    if !file_path.exists() {
        tracing::warn!("EntityGenerator: Creating file \"{}\"", file_path.display());
        tokio::fs::create_dir_all(file_path.parent().unwrap()).await?;
    }
    tokio::fs::write(file_path, &content).await?;

    Ok(())
}
